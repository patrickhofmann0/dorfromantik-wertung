name: build
on: 
    push:

jobs: 
    unit-test:
        runs-on: ubuntu-latest
        name: Run Unit Tests
        steps:
        - uses: actions/checkout@v4

        - name: Set up Node.js

          uses: actions/setup-node@v4
          with:
            node-version: 'lts/*'

        - name: Install dependencies
          run: npm ci

        - name: Run unit tests
          run: npm run test

    playwright-test:
        timeout-minutes: 60
        runs-on: ubuntu-latest
        name: Run Playwright Tests
        steps:
        - uses: actions/checkout@v4

        - uses: actions/setup-node@v4

          with:
            node-version: lts/*

        - name: Install dependencies
          run: | 
            npm ci

        - name: Install Playwright Browsers
          run:  | 
            npx playwright install --with-deps

        - name: Run app server
          run: | 
            npm run start

        - name: Wait for server to be ready
          run: |
            npx wait-on http://localhost:4200

        - name: Run Playwright tests
          run: | 
            npm run test-headless

        - uses: actions/upload-artifact@v4
          if: ${{ !cancelled() }}
          with:
            name: playwright-report

    build:
        runs-on: ubuntu-latest
        name: build app 
        needs: [unit-test, playwright-test]
        steps:
        - uses: actions/checkout@v4

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 'lts/*'

        - name: Install dependencies
          run: npm ci

        - name: Build app
          run: npm run build